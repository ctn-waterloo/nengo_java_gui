<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<project basedir="." default="build" name="nengo-ui">
    <property environment="env"/>
    <property name="dir.simulator" value="../simulator"/>
	<property file="${dir.simulator}/build.properties"/>
	<path id="classpath.simulator">
        <pathelement location="${dir.simulator}/${dest.build}"/>
    	<fileset dir="${dir.simulator}/${src.lib}">
    		<include name="*.jar"/>
    		<exclude name="junit.jar"/>
    	</fileset>
	</path>
    <path id="classpath.simulator-ui">
    	<path refid="classpath.simulator"/>
    	<pathelement location="${dest.build}"/>
    	<fileset dir="${src.lib}">
    		<include name="*.jar"/>
    		<exclude name="junit.jar"/>
    	</fileset>
    </path>
	<path id="classpath.test">
		<path refid="classpath.simulator-ui"/>
		<pathelement location="${dest.test}"/>
      	<pathelement location="${src.lib}/junit.jar"/>
	</path>
    <target name="init">
    	<mkdir dir="${dest.artifacts}"/>
        <mkdir dir="${dest.build}"/>
        <copy includeemptydirs="false" todir="${dest.build}">
            <fileset dir="${src.main}">
                <exclude name="**/*.launch"/>
                <exclude name="**/*.java"/>
            </fileset>
        </copy>
        <copy includeemptydirs="false" todir="${dest.build}">
            <fileset dir="${src.resources}">
                <exclude name="**/*.launch"/>
                <exclude name="**/*.java"/>
            </fileset>
        </copy>
    </target>
	<target name="init-test">
		<mkdir dir="${dest.artifacts}"/>
		<mkdir dir="${dest.artifacts.reports}"/>
		<mkdir dir="${dest.test}"/>
        <copy includeemptydirs="false" todir="${dest.test}">
            <fileset dir="${src.test}">
                <exclude name="**/*.launch"/>
                <exclude name="**/*.java"/>
            </fileset>
        </copy>
	</target>
    <target name="clean">
    	<delete dir="${dest.artifacts}"/>
        <delete dir="${dest.build}"/>
    	<delete dir="${dest.test}"/>
    </target>
    <target name="build-simulator">
        <ant dir="${dir.simulator}" inheritAll="false" target="build" />
    </target>
    <target description="Build simulator-ui. Produces .class files in the ${dest.build} directory."
			depends="init,build-simulator" name="build">
        <echo message="${ant.project.name}: ${ant.file}"/>
        <javac debug="true" debuglevel="${java.debuglevel}" destdir="${dest.build}" source="${java.source}" target="${java.target}">
            <src path="${src.main}"/>
            <classpath refid="classpath.simulator-ui"/>
        </javac>
	</target>
    <target description="Run JUnit tests and produce reports."
			depends="init-test,build" name="test">
        <copy includeemptydirs="false" todir="${dest.test}">
            <fileset dir="${src.test}">
                <exclude name="**/*.launch"/>
                <exclude name="**/*.java"/>
            </fileset>
        </copy>
		<javac debug="true" debuglevel="${java.debuglevel}" destdir="${dest.test}" source="${java.source}" target="${java.target}">
	        <src path="${src.test}"/>
            <classpath refid="classpath.test"/>
        </javac>
		<junit fork="yes" printsummary="no" haltonfailure="no">
			<batchtest fork="yes" todir="${dest.artifacts.reports}" >
				<fileset dir="${dest.test}">
			    	<include name="**/*Test.class" />
			    </fileset>
			</batchtest>
			<formatter type="xml"/>
			<classpath refid="classpath.test"/>
		</junit>
		<junitreport todir="${dest.artifacts.reports}">
			<fileset dir="${dest.artifacts.reports}">
		    	<include name="TEST-*.xml" />
		    </fileset>
		    <report todir="${dest.artifacts.reports}" />
		</junitreport>
    </target>
	<target description="Generate JavaDoc." name="javadoc">
		<mkdir dir="${dest.artifacts.javadoc}"/>
		<javadoc sourcepath="${src.main}" destdir="${dest.artifacts.javadoc}"
				 author="true" version="true" windowtitle="Nengo GUI API"/>
	</target>
	<target description="Create a distribution folder."
		depends="build" name="dist">
		<ant dir="${dir.simulator}" inheritAll="false" target="javadoc" />
		<copy includeemptydirs="false" todir="${dest.build}">
	        <fileset dir="${dir.simulator}/${dest.build}">
	            <exclude name="**/*.launch"/>
	            <exclude name="**/*.java"/>
	        </fileset>
	    </copy>
		<delete dir="${dist.dir}"/>
		<mkdir dir="${dist.dir}"/>
		<jar destfile="${dist.jar}" basedir="${dest.build}">
	    	<manifest>
		    	<attribute name="Main-Class" value="ca.nengo.ui.NengoGraphics" />
			  	<attribute name="Built-By" value="${user.name}"/>
			  	<attribute name="Implementation-Vendor" value="Centre for Theoretical Neuroscience @ UWaterloo"/>
			  	<attribute name="Implementation-Title" value="Nengo Graphical Simulator"/>
			  	<attribute name="Implementation-Version" value="1.2-SNAPSHOT"/>
	    	</manifest>
		</jar>
		<mkdir dir="${dist.dir}/api"/>
		<mkdir dir="${dist.dir}/api/docs"/>
		<mkdir dir="${dist.dir}/api/src"/>
		<copy includeemptydirs="false" todir="${dist.dir}/api/docs">
			<fileset dir="${dir.simulator}/${dest.artifacts.javadoc}"/>
		</copy>
		<copy includeemptydirs="false" todir="${dist.dir}/api/src">
			<fileset dir="${dir.simulator}/${src.main}"/>
		</copy>
		<copy includeemptydirs="false" todir="${dist.dir}">
			<fileset dir=".">
				<include name="external/**"/>
				<include name="images/**"/>
				<include name="python/**"/>
				<include name="${src.lib}/**"/>
			</fileset>
			<fileset dir="${dir.simulator}">
				<include name="${src.lib}/**"/>
			</fileset>
			<fileset dir="${src.dist}"/>
		</copy>
		<chmod perm="a+x" verbose="true">
			<fileset dir="${dist.dir}">
				<include name="nengo"/>
				<include name="external/pseudoInverse"/>
			</fileset>
		</chmod>
	</target>
</project>
